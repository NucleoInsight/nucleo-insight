<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Analytics | Admin & Tools</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0c15; color: #a5b4fc; font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; }
        .funnel-step { position: relative; padding-left: 20px; border-left: 2px solid #334155; margin-bottom: 20px; }
        .funnel-step.active { border-left-color: #10b981; }
        .funnel-step::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #334155; border-radius: 50%; }
        .funnel-step.active::before { background: #10b981; box-shadow: 0 0 10px #10b981; }
        
        .metric-value { font-size: 1.5rem; font-weight: 800; color: white; }
        .metric-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; }
        
        .progress-bar-bg { background: #1e293b; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); width: 0%; transition: width 1s; }
        
        .loading-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }

        /* Impress√£o PDF Limpa */
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            .glass-panel { border: 1px solid #ccc; background: none; color: black; box-shadow: none; }
            .text-white { color: black !important; }
            .metric-value { color: black !important; }
            canvas { max-height: 200px; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto">
        
        <header class="flex flex-col md:flex-row justify-between items-end mb-10 border-b border-indigo-900/30 pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">SNIPER <span class="text-indigo-500">ANALYTICS</span></h1>
                <p class="text-xs text-indigo-400 mt-1">Painel de Controle & F√°brica de Links</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-800/50 p-2 rounded-lg border border-slate-700 no-print">
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Modo Teste</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-test" class="sr-only peer" onchange="initSystem()">
                        <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-500"></div>
                    </label>
                </div>

                <div class="text-right hidden md:block">
                    <p class="text-[10px] text-slate-500 uppercase">Status</p>
                    <div class="flex items-center gap-2 justify-end">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span id="system-status" class="text-xs text-emerald-400 font-bold">ONLINE</span>
                    </div>
                </div>

                <div class="flex gap-2 no-print">
                    <button onclick="copyReport()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-xs font-bold transition" title="Copiar para IA">
                        üìã COPIAR
                    </button>
                    <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-xs font-bold transition" title="Salvar PDF">
                        üñ®Ô∏è PDF
                    </button>
                    <button onclick="initSystem()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-indigo-500/20">
                        üîÑ ATUALIZAR
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            <div class="glass-panel p-6">
                <h2 class="text-sm font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    FUNIL DE RETEN√á√ÉO
                </h2>
                <div id="funnel-container" class="space-y-6">
                    <div class="text-center text-slate-600 text-xs py-10 loading-pulse">Carregando dados...</div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-4 border-l-2 border-indigo-500">
                        <p class="metric-label">Visitantes</p>
                        <p id="kpi-unique" class="metric-value">0</p>
                    </div>
                    <div class="glass-panel p-4 border-l-2 border-emerald-500">
                        <p class="metric-label">Convers√£o ($)</p>
                        <p id="kpi-cr" class="metric-value">0%</p>
                    </div>
                    <div class="glass-panel p-4 border-l-2 border-pink-500">
                        <p class="metric-label">Reten√ß√£o Quiz</p>
                        <p id="kpi-retention" class="metric-value">0%</p>
                    </div>
                    <div class="glass-panel p-4 border-l-2 border-amber-500">
                        <p class="metric-label">Melhor Canal</p>
                        <p id="kpi-source" class="text-lg font-bold text-white truncate">...</p>
                    </div>
                </div>

                <div class="glass-panel p-4">
                    <h3 class="text-xs font-bold text-white mb-4">ORIGEM DO TR√ÅFEGO</h3>
                    <canvas id="sourceChart" height="150"></canvas>
                </div>
            </div>

            <div class="glass-panel p-0 overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-white/5 bg-slate-900/50 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-white">üì° FEED AO VIVO</h3>
                    <span id="feed-badge" class="text-[9px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded">REAL</span>
                </div>
                <div class="overflow-y-auto p-4 space-y-3" id="live-feed"></div>
            </div>
        </div>

        <div class="glass-panel p-6 mb-10 no-print border border-emerald-500/30">
            <h2 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                üè≠ F√°brica de Links Rastreados
                <span class="text-[10px] bg-emerald-900 text-emerald-400 px-2 py-1 rounded border border-emerald-500/50">NOVO</span>
            </h2>
            <p class="text-xs text-slate-400 mb-6">Crie links curtos (arquivos HTML) para rastrear WhatsApp, Bio e An√∫ncios.</p>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Nome do Arquivo (Curto)</label>
                    <div class="flex">
                        <span class="bg-slate-700 text-slate-300 p-2 text-xs rounded-l border border-slate-600">/</span>
                        <input type="text" id="linkName" placeholder="ex: zap" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2 focus:border-emerald-500 outline-none">
                        <span class="bg-slate-700 text-slate-300 p-2 text-xs rounded-r border border-slate-600">.html</span>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-emerald-500 mb-1 uppercase">Origem (Source)</label>
                    <input type="text" id="utmSource" value="whatsapp" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2 rounded focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-emerald-500 mb-1 uppercase">Campanha</label>
                    <input type="text" id="utmCampaign" placeholder="palhaco" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2 rounded focus:border-emerald-500 outline-none">
                </div>
            </div>

            <button onclick="generateLinkCode()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg text-xs transition mb-4">
                ‚ú® GERAR C√ìDIGO DO ARQUIVO
            </button>

            <div id="codeResult" class="hidden">
                <textarea id="htmlOutput" class="w-full h-24 bg-black/50 text-emerald-400 font-mono text-[10px] p-3 rounded border border-slate-700 mb-2" readonly></textarea>
                <p class="text-[10px] text-slate-400">1. Copie o c√≥digo acima. 2. Crie um arquivo no GitHub com o nome que voc√™ escolheu. 3. Seu link ser√°: <strong id="finalUrlPreview" class="text-white">...</strong></p>
            </div>
        </div>

        <div class="border border-red-900/30 bg-red-950/10 rounded-xl p-6 no-print">
            <h3 class="text-red-500 font-bold text-sm mb-2 uppercase">‚ö†Ô∏è Zona de Perigo (Gerenciamento de Dados)</h3>
            <p class="text-xs text-slate-400 mb-4">A√ß√µes aqui s√£o irrevers√≠veis. O bot√£o abaixo apaga os dados baseados no modo atual (Teste ou Real).</p>
            
            <div class="flex items-center gap-4">
                <button onclick="clearDatabase()" class="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-800 px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    üóëÔ∏è APAGAR TODOS OS DADOS DO MODO ATUAL
                </button>
                <p id="delete-status" class="text-xs text-slate-500 italic"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFnz5Wis_b3CGGblNn-bfUjqEgTOlqGNE",
            authDomain: "nucleoinsight-e4566.firebaseapp.com",
            projectId: "nucleoinsight-e4566",
            storageBucket: "nucleoinsight-e4566.firebasestorage.app",
            messagingSenderId: "650150743348",
            appId: "1:650150743348:web:f62f3cc95a38a5e90ca961",
            measurementId: "G-M24P3TBP5J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myChart = null;
        let globalFunnelData = {}; // Para copiar
        let globalSourceData = {}; // Para copiar

        // --- SISTEMA DE GERA√á√ÉO DE LINKS (Encurtador) ---
        window.generateLinkCode = () => {
            const name = document.getElementById('linkName').value || 'link';
            const source = document.getElementById('utmSource').value || 'direct';
            const campaign = document.getElementById('utmCampaign').value || 'none';
            const medium = 'chat'; // Padr√£o
            
            const targetUrl = `https://nucleoinsight.github.io/nucleo-insight/?utm_source=${source}&utm_medium=${medium}&utm_campaign=${campaign}&utm_content=${name}`;
            
            const code = `<!DOCTYPE html>
<html lang="pt-br">
<head><meta charset="UTF-8"><meta http-equiv="refresh" content="0; url=${targetUrl}">
<script>window.location.href = "${targetUrl}";<\/script>
<title>Redirecionando...</title></head><body>Aguarde...</body></html>`;

            document.getElementById('htmlOutput').value = code;
            document.getElementById('finalUrlPreview').innerText = `https://nucleoinsight.github.io/nucleo-insight/${name}.html`;
            document.getElementById('codeResult').classList.remove('hidden');
        };

        // --- SISTEMA DE C√ìPIA DE RELAT√ìRIO ---
        window.copyReport = () => {
            const isTest = document.getElementById('toggle-test').checked;
            const text = `
üìä *RELAT√ìRIO SNIPER ANALYTICS*
üìÖ Data: ${new Date().toLocaleString()}
MODE: ${isTest ? 'TESTE üß™' : 'REAL üî•'}

üîª *FUNIL DE CONVERS√ÉO*
- Visitantes: ${globalFunnelData.visitors || 0}
- Iniciou Quiz: ${globalFunnelData.startedQuiz || 0}
- Engajados: ${globalFunnelData.midQuiz || 0}
- Checkout (Clique): ${globalFunnelData.clickedCheckout || 0}

üìà *TAXAS*
- Reten√ß√£o Quiz: ${document.getElementById('kpi-retention').innerText}
- Convers√£o Venda: ${document.getElementById('kpi-cr').innerText}

üèÜ *TOP ORIGENS*
${Object.entries(globalSourceData).map(([k,v]) => `- ${k}: ${v}`).join('\n')}
            `;
            navigator.clipboard.writeText(text).then(() => alert('Relat√≥rio copiado! Cole no chat da IA.'));
        };

        // --- SISTEMA DE LIMPEZA DE DADOS ---
        window.clearDatabase = async () => {
            const isTest = document.getElementById('toggle-test').checked;
            const modeName = isTest ? "MODO TESTE" : "MODO REAL";
            
            if(!confirm(`‚ö†Ô∏è PERIGO!\n\nVoc√™ tem certeza que deseja APAGAR TODOS os dados do ${modeName}?\n\nIsso n√£o pode ser desfeito.`)) return;

            const statusEl = document.getElementById('delete-status');
            statusEl.innerText = "Apagando documentos... aguarde.";
            
            const eventsRef = collection(db, "analytics_events");
            const snapshot = await getDocs(eventsRef);
            
            let count = 0;
            const deletePromises = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                // L√≥gica de filtro id√™ntica ao initSystem
                const docIsTest = data.isTest === true;
                
                // Se estamos no modo teste, apaga s√≥ o que √© teste
                // Se estamos no modo real, apaga s√≥ o que N√ÉO √© teste
                if ((isTest && docIsTest) || (!isTest && !docIsTest)) {
                    deletePromises.push(deleteDoc(doc(db, "analytics_events", docSnap.id)));
                    count++;
                }
            });

            await Promise.all(deletePromises);
            
            statusEl.innerText = `Sucesso! ${count} registros apagados do ${modeName}.`;
            setTimeout(() => initSystem(), 1500); // Recarrega
        };

        // --- SISTEMA PRINCIPAL DE DADOS ---
        window.initSystem = async () => {
            const showTestMode = document.getElementById('toggle-test').checked;
            
            // Atualiza UI
            const statusEl = document.getElementById('system-status');
            const badgeEl = document.getElementById('feed-badge');
            
            if(showTestMode) {
                statusEl.innerText = "MODO TESTE (SandBox)";
                statusEl.className = "text-xs text-amber-400 font-bold";
                badgeEl.innerText = "TESTES";
                badgeEl.className = "text-[9px] bg-amber-500/20 text-amber-400 px-2 py-1 rounded";
            } else {
                statusEl.innerText = "ONLINE (Real)";
                statusEl.className = "text-xs text-emerald-400 font-bold";
                badgeEl.innerText = "DADOS REAIS";
                badgeEl.className = "text-[9px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded";
            }

            const eventsRef = collection(db, "analytics_events");
            const q = query(eventsRef, orderBy("timestamp", "desc"), limit(1000));
            const snapshot = await getDocs(q);

            const sessions = {};
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const isTestData = data.isTest === true;
                
                // Filtro Mestre
                if (showTestMode && !isTestData) return; 
                if (!showTestMode && isTestData) return; 

                const sid = data.sessionId || 'anonymous'; 
                
                if (!sessions[sid]) {
                    sessions[sid] = {
                        id: sid,
                        startTime: data.timestamp,
                        events: [],
                        source: data.campaign?.source || 'direct',
                        maxStep: 0,
                        reachedCheckout: false
                    };
                }
                sessions[sid].events.push(data);

                if (data.eventName === 'quiz_answer') {
                    const qNum = data.data.question_number || 0;
                    if (qNum > sessions[sid].maxStep) sessions[sid].maxStep = qNum;
                }
                if (data.eventName === 'click' && (data.data.label?.includes('Desbloquear') || data.data.id === 'btn-checkout')) {
                    sessions[sid].reachedCheckout = true;
                }
            });

            const totalSessions = Object.keys(sessions).length;
            const funnel = { visitors: 0, startedQuiz: 0, midQuiz: 0, finishedQuiz: 0, clickedCheckout: 0 };
            const sourcesCount = {};

            Object.values(sessions).forEach(s => {
                funnel.visitors++;
                sourcesCount[s.source] = (sourcesCount[s.source] || 0) + 1;
                const hasQuizEvent = s.events.some(e => e.eventName === 'quiz_answer'); // Melhor detec√ß√£o
                
                // Corre√ß√£o de l√≥gica: Se engajou ou finalizou, obrigatoriamente iniciou
                if (hasQuizEvent || s.maxStep > 0) funnel.startedQuiz++;
                if (s.maxStep >= 5) funnel.midQuiz++;
                if (s.maxStep >= 9) funnel.finishedQuiz++; 
                if (s.reachedCheckout) funnel.clickedCheckout++;
            });

            // Salva globais para o bot√£o Copiar
            globalFunnelData = funnel;
            globalSourceData = sourcesCount;

            renderDashboard(funnel, totalSessions, sessions, sourcesCount);
        };

        function renderDashboard(funnel, total, sessions, sources) {
            const container = document.getElementById('funnel-container');
            const steps = [
                { label: "Visitas na P√°gina", count: funnel.visitors, color: "text-white" },
                { label: "Iniciou Quiz", count: funnel.startedQuiz, color: "text-indigo-400" },
                { label: "Engajados (+5 Pergs)", count: funnel.midQuiz, color: "text-purple-400" },
                { label: "Finalizou Quiz", count: funnel.finishedQuiz, color: "text-fuchsia-400" },
                { label: "Clicou Checkout", count: funnel.clickedCheckout, color: "text-emerald-400" }
            ];

            let html = '';
            steps.forEach((step, index) => {
                const prevCount = index === 0 ? step.count : steps[index-1].count;
                const conversion = prevCount > 0 ? ((step.count / prevCount) * 100).toFixed(1) : 0;
                const totalConv = total > 0 ? ((step.count / total) * 100).toFixed(1) : 0;
                
                html += `
                <div class="funnel-step active">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-[10px] uppercase text-slate-500 font-bold">${step.label}</p>
                            <p class="text-xl font-black ${step.color}">${step.count}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-bold text-slate-400">${conversion}% <span class="text-[9px] font-normal opacity-50">do anterior</span></p>
                        </div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: ${totalConv}%"></div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;

            document.getElementById('kpi-unique').innerText = total;
            const checkoutRate = funnel.finishedQuiz > 0 ? ((funnel.clickedCheckout / funnel.finishedQuiz) * 100).toFixed(1) : 0;
            document.getElementById('kpi-cr').innerText = checkoutRate + "%";
            document.getElementById('kpi-cr').className = `metric-value ${checkoutRate > 15 ? 'text-emerald-400' : 'text-red-400'}`;
            
            const retention = funnel.visitors > 0 ? ((funnel.finishedQuiz / funnel.visitors) * 100).toFixed(1) : 0;
            document.getElementById('kpi-retention').innerText = retention + "%";
            
            const bestSource = Object.keys(sources).reduce((a, b) => sources[a] > sources[b] ? a : b, '-');
            document.getElementById('kpi-source').innerText = bestSource.toUpperCase();

            renderFeed(sessions);
            renderChart(sources);
        }

        function renderFeed(sessions) {
            const feed = document.getElementById('live-feed');
            feed.innerHTML = '';
            
            const sortedSessions = Object.values(sessions).sort((a,b) => {
                const timeA = a.events[0]?.timestamp || 0;
                const timeB = b.events[0]?.timestamp || 0;
                return timeB - timeA;
            }).slice(0, 30); 

            if(sortedSessions.length === 0) {
                feed.innerHTML = '<div class="text-center text-slate-600 text-xs py-10">Nenhuma sess√£o encontrada neste modo.</div>';
            }

            sortedSessions.forEach(s => {
                const lastAction = s.events[0].eventName;
                const time = new Date(s.events[0].timestamp.seconds * 1000).toLocaleTimeString();
                let badge = '<span class="bg-slate-700 text-white text-[9px] px-2 rounded">Visitante</span>';
                if(s.reachedCheckout) badge = '<span class="bg-emerald-500 text-black font-bold text-[9px] px-2 rounded">HOT LEAD üî•</span>';
                else if(s.maxStep > 5) badge = '<span class="bg-indigo-500 text-white text-[9px] px-2 rounded">Engajado</span>';

                feed.innerHTML += `
                <div class="p-3 bg-white/5 rounded border border-white/5 hover:border-indigo-500/50 transition">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-mono text-slate-400">${time}</span>
                        ${badge}
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-300">Origem: <strong class="text-white uppercase">${s.source}</strong></span>
                        <span class="text-slate-500">${s.events.length} a√ß√µes</span>
                    </div>
                    <div class="mt-2 text-[10px] text-slate-500 truncate">
                        A√ß√£o: ${lastAction}
                    </div>
                </div>`;
            });
        }

        function renderChart(data) {
            const ctx = document.getElementById('sourceChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } } }
                }
            });
        }
        
        initSystem();
    </script>
</body>
</html>
