<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Analytics | N√∫cleo Insight</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0c15; color: #a5b4fc; font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; }
        .funnel-step { position: relative; padding-left: 20px; border-left: 2px solid #334155; margin-bottom: 20px; }
        .funnel-step.active { border-left-color: #10b981; }
        .funnel-step::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #334155; border-radius: 50%; }
        .funnel-step.active::before { background: #10b981; box-shadow: 0 0 10px #10b981; }
        
        .metric-value { font-size: 1.5rem; font-weight: 800; color: white; }
        .metric-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; }
        
        /* Barra de Progresso do Funil */
        .progress-bar-bg { background: #1e293b; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); width: 0%; transition: width 1s; }
        
        .loading-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto">
        
        <header class="flex justify-between items-end mb-10 border-b border-indigo-900/30 pb-4">
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">SNIPER <span class="text-indigo-500">ANALYTICS</span></h1>
                <p class="text-xs text-indigo-400 mt-1">Rastreamento de Sess√£o √önica & Funil de Convers√£o</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-[10px] text-slate-500 uppercase">Status do Sistema</p>
                    <div class="flex items-center gap-2 justify-end">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span class="text-xs text-emerald-400 font-bold">ONLINE</span>
                    </div>
                </div>
                <button onclick="initSystem()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-indigo-500/20">
                    üîÑ ATUALIZAR DADOS
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="glass-panel p-6">
                <h2 class="text-sm font-bold text-white mb-6 flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    FUNIL DE RETEN√á√ÉO (Sess√µes √önicas)
                </h2>
                
                <div id="funnel-container" class="space-y-6">
                    <div class="text-center text-slate-600 text-xs py-10 loading-pulse">Calculando taxas de convers√£o...</div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-4 border-l-2 border-indigo-500">
                        <p class="metric-label">Visitantes √önicos</p>
                        <p id="kpi-unique" class="metric-value">0</p>
                    </div>
                    <div class="glass-panel p-4 border-l-2 border-emerald-500">
                        <p class="metric-label">Taxa Checkout</p>
                        <p id="kpi-cr" class="metric-value">0%</p>
                    </div>
                    <div class="glass-panel p-4 border-l-2 border-pink-500">
                        <p class="metric-label">Reten√ß√£o Quiz</p>
                        <p id="kpi-retention" class="metric-value">0%</p>
                    </div>
                    <div class="glass-panel p-4 border-l-2 border-amber-500">
                        <p class="metric-label">Lead Quente (UTM)</p>
                        <p id="kpi-source" class="text-lg font-bold text-white truncate">...</p>
                    </div>
                </div>

                <div class="glass-panel p-4">
                    <h3 class="text-xs font-bold text-white mb-4">ORIGEM DO TR√ÅFEGO (Sess√µes)</h3>
                    <canvas id="sourceChart" height="150"></canvas>
                </div>
            </div>

            <div class="glass-panel p-0 overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-white/5 bg-slate-900/50">
                    <h3 class="text-xs font-bold text-white">üì° FEED DE SESS√ïES (Quem est√° online?)</h3>
                </div>
                <div class="overflow-y-auto p-4 space-y-3" id="live-feed">
                    </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFnz5Wis_b3CGGblNn-bfUjqEgTOlqGNE",
            authDomain: "nucleoinsight-e4566.firebaseapp.com",
            projectId: "nucleoinsight-e4566",
            storageBucket: "nucleoinsight-e4566.firebasestorage.app",
            messagingSenderId: "650150743348",
            appId: "1:650150743348:web:f62f3cc95a38a5e90ca961",
            measurementId: "G-M24P3TBP5J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myChart = null;

        // --- L√ìGICA DE INTELIG√äNCIA ---
        window.initSystem = async () => {
            const eventsRef = collection(db, "analytics_events");
            // Pega os √∫ltimos 500 eventos para ter amostra boa
            const q = query(eventsRef, orderBy("timestamp", "desc"), limit(500));
            const snapshot = await getDocs(q);

            // 1. PROCESSAR SESS√ïES (Agrupar eventos por pessoa)
            const sessions = {};
            
            snapshot.forEach(doc => {
                const data = doc.data();
                // Usa sessionId se existir, sen√£o usa IP ou cria um fake baseado no timestamp (fallback)
                const sid = data.sessionId || 'anonymous'; 
                
                if (!sessions[sid]) {
                    sessions[sid] = {
                        id: sid,
                        startTime: data.timestamp,
                        events: [],
                        source: data.campaign?.source || 'direct',
                        device: data.device?.platform || 'Mobile',
                        maxStep: 0,
                        reachedCheckout: false
                    };
                }
                sessions[sid].events.push(data);

                // Analisa profundidade
                if (data.eventName === 'quiz_answer') {
                    const qNum = data.data.question_number || 0;
                    if (qNum > sessions[sid].maxStep) sessions[sid].maxStep = qNum;
                }
                if (data.eventName === 'click' && (data.data.label.includes('Desbloquear') || data.data.id === 'btn-checkout')) {
                    sessions[sid].reachedCheckout = true;
                }
            });

            // 2. CALCULAR FUNIL (Baseado em SESS√ïES √öNICAS, n√£o cliques)
            const totalSessions = Object.keys(sessions).length;
            const funnel = {
                visitors: 0,
                startedQuiz: 0,
                midQuiz: 0, // Chegou na metade
                finishedQuiz: 0, // Respondeu ultima
                clickedCheckout: 0
            };

            const sourcesCount = {};

            Object.values(sessions).forEach(s => {
                funnel.visitors++;
                
                // Contagem de Origem
                sourcesCount[s.source] = (sourcesCount[s.source] || 0) + 1;

                // L√≥gica do Funil
                const hasQuizEvent = s.events.some(e => e.eventName === 'quiz_answer');
                
                if (hasQuizEvent) funnel.startedQuiz++;
                if (s.maxStep >= 5) funnel.midQuiz++;
                if (s.maxStep >= 9) funnel.finishedQuiz++; // Assumindo 9 ou 10 perguntas
                if (s.reachedCheckout) funnel.clickedCheckout++;
            });

            renderDashboard(funnel, totalSessions, sessions, sourcesCount);
        };

        function renderDashboard(funnel, total, sessions, sources) {
            // 1. Renderizar Funil Visual
            const container = document.getElementById('funnel-container');
            
            const steps = [
                { label: "Visitas na P√°gina", count: funnel.visitors, color: "text-white" },
                { label: "Iniciou Quiz", count: funnel.startedQuiz, color: "text-indigo-400" },
                { label: "Engajados (+5 Pergs)", count: funnel.midQuiz, color: "text-purple-400" },
                { label: "Finalizou Quiz", count: funnel.finishedQuiz, color: "text-fuchsia-400" },
                { label: "Clicou Checkout", count: funnel.clickedCheckout, color: "text-emerald-400" }
            ];

            let html = '';
            steps.forEach((step, index) => {
                const prevCount = index === 0 ? step.count : steps[index-1].count;
                const conversion = prevCount > 0 ? ((step.count / prevCount) * 100).toFixed(1) : 0;
                const totalConv = total > 0 ? ((step.count / total) * 100).toFixed(1) : 0;
                
                // Largura da barra baseada na % do total
                const width = Math.max(totalConv, 1); // Minimo 1% pra aparecer

                html += `
                <div class="funnel-step active">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-[10px] uppercase text-slate-500 font-bold">${step.label}</p>
                            <p class="text-xl font-black ${step.color}">${step.count}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-bold text-slate-400">${conversion}% <span class="text-[9px] font-normal opacity-50">passo anterior</span></p>
                        </div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: ${totalConv}%"></div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;

            // 2. Atualizar KPIs
            document.getElementById('kpi-unique').innerText = total;
            
            const checkoutRate = funnel.finishedQuiz > 0 ? ((funnel.clickedCheckout / funnel.finishedQuiz) * 100).toFixed(1) : 0;
            document.getElementById('kpi-cr').innerText = checkoutRate + "%";
            document.getElementById('kpi-cr').className = `metric-value ${checkoutRate > 15 ? 'text-emerald-400' : 'text-red-400'}`;

            const retention = funnel.visitors > 0 ? ((funnel.finishedQuiz / funnel.visitors) * 100).toFixed(1) : 0;
            document.getElementById('kpi-retention').innerText = retention + "%";

            // Melhor Origem
            const bestSource = Object.keys(sources).reduce((a, b) => sources[a] > sources[b] ? a : b, '-');
            document.getElementById('kpi-source').innerText = bestSource.toUpperCase();

            // 3. Renderizar Feed de Sess√µes
            const feed = document.getElementById('live-feed');
            feed.innerHTML = '';
            
            // Ordenar sess√µes mais recentes primeiro (baseado no ultimo evento)
            const sortedSessions = Object.values(sessions).sort((a,b) => {
                const timeA = a.events[0]?.timestamp || 0;
                const timeB = b.events[0]?.timestamp || 0;
                return timeB - timeA;
            }).slice(0, 20); // Top 20

            sortedSessions.forEach(s => {
                const lastAction = s.events[0].eventName;
                const time = new Date(s.events[0].timestamp.seconds * 1000).toLocaleTimeString();
                
                let badge = '<span class="bg-slate-700 text-white text-[9px] px-2 rounded">Visitante</span>';
                if(s.reachedCheckout) badge = '<span class="bg-emerald-500 text-black font-bold text-[9px] px-2 rounded">HOT LEAD üî•</span>';
                else if(s.maxStep > 5) badge = '<span class="bg-indigo-500 text-white text-[9px] px-2 rounded">Engajado</span>';

                feed.innerHTML += `
                <div class="p-3 bg-white/5 rounded border border-white/5 hover:border-indigo-500/50 transition">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-mono text-slate-400">${time}</span>
                        ${badge}
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-300">Origem: <strong class="text-white uppercase">${s.source}</strong></span>
                        <span class="text-slate-500">${s.events.length} a√ß√µes</span>
                    </div>
                    <div class="mt-2 text-[10px] text-slate-500 truncate">
                        Ultima a√ß√£o: ${lastAction}
                    </div>
                </div>`;
            });

            // 4. Gr√°fico
            renderChart(sources);
        }

        function renderChart(data) {
            const ctx = document.getElementById('sourceChart').getContext('2d');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } } }
                }
            });
        }

        // Auto start
        initSystem();
    </script>
</body>
</html>
