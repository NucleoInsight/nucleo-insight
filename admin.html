<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFnz5Wis_b3CGGblNn-bfUjqEgTOlqGNE",
            authDomain: "nucleoinsight-e4566.firebaseapp.com",
            projectId: "nucleoinsight-e4566",
            storageBucket: "nucleoinsight-e4566.firebasestorage.app",
            messagingSenderId: "650150743348",
            appId: "1:650150743348:web:f62f3cc95a38a5e90ca961",
            measurementId: "G-M24P3TBP5J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Vari√°veis globais para o relat√≥rio
        window.globalFunnelData = {}; 
        window.globalSourceData = {}; 

        // --- SALVAR LINK NO FIREBASE (CORRIGIDO E BLINDADO) ---
        window.saveLinkToFirebase = async () => {
            let nameInput = document.getElementById('linkName').value;
            
            // 1. LIMPEZA AUTOM√ÅTICA (Remove https, barras e espa√ßos se voc√™ colar errado)
            let cleanName = nameInput.replace(/https?:\/\//g, "").replace(/\//g, "").replace(/\s/g, "").split('?')[0];
            
            // Se o nome estava vazio ou ficou vazio ap√≥s limpar
            if(!cleanName) return alert("Digite apenas uma palavra para o link (ex: zap). N√£o cole URLs aqui!");
            
            // Atualiza o campo visualmente para voc√™ ver o nome limpo
            document.getElementById('linkName').value = cleanName;

            const btn = document.getElementById('btnSaveLink');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;
            
            const source = document.getElementById('utmSource').value || 'direct';
            const campaign = document.getElementById('utmCampaign').value || 'none';
            const medium = 'chat';
            
            // O Link de Destino (Longo) √© gerado sozinho aqui
            const longUrl = `https://nucleoinsight.github.io/nucleo-insight/?utm_source=${source}&utm_medium=${medium}&utm_campaign=${campaign}&utm_content=${cleanName}`;
            
            // O Link Curto final
            const shortUrl = `https://nucleoinsight.github.io/nucleo-insight/r.html?id=${cleanName}`;

            try {
                // Salva no Banco com o ID limpo
                await setDoc(doc(db, "short_links", cleanName), {
                    target: longUrl,
                    clicks: 0,
                    created_at: new Date()
                });

                document.getElementById('finalLinkDisplay').innerText = shortUrl;
                document.getElementById('codeResult').classList.remove('hidden');
                btn.innerText = "‚úÖ SALVO COM SUCESSO!";
                setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 3000);
                
            } catch (error) {
                console.error("Erro Firebase:", error);
                alert("Erro ao salvar: " + error.message);
                btn.innerText = "Erro (Tente Novamente)";
                btn.disabled = false;
            }
        };

        window.copyFinalLink = () => {
            const link = document.getElementById('finalLinkDisplay').innerText;
            navigator.clipboard.writeText(link).then(() => alert("Link copiado!"));
        }

        // --- FUN√á√ïES DO PAINEL (Mantidas iguais) ---
        window.copyReport = () => {
            const isTest = document.getElementById('toggle-test').checked;
            const text = `üìä *RELAT√ìRIO SNIPER ANALYTICS*\nüìÖ Data: ${new Date().toLocaleString()}\nMODE: ${isTest ? 'TESTE üß™' : 'REAL üî•'}\n\nüîª *FUNIL*\n- Visitantes: ${window.globalFunnelData.visitors || 0}\n- Iniciou Quiz: ${window.globalFunnelData.startedQuiz || 0}\n- Checkout: ${window.globalFunnelData.clickedCheckout || 0}\n\nüèÜ *TOP ORIGENS*\n${Object.entries(window.globalSourceData).map(([k,v]) => `- ${k}: ${v}`).join('\n')}`;
            navigator.clipboard.writeText(text).then(() => alert('Relat√≥rio copiado!'));
        };

        window.clearDatabase = async () => {
            const isTest = document.getElementById('toggle-test').checked;
            if(!confirm(`‚ö†Ô∏è Apagar TODOS os dados do ${isTest ? "MODO TESTE" : "MODO REAL"}?`)) return;
            const statusEl = document.getElementById('delete-status');
            statusEl.innerText = "Apagando...";
            const snapshot = await getDocs(collection(db, "analytics_events"));
            const promises = [];
            snapshot.forEach(d => {
                const data = d.data();
                // L√≥gica de filtro segura
                if ((isTest && data.isTest === true) || (!isTest && data.isTest !== true)) {
                    promises.push(deleteDoc(doc(db, "analytics_events", d.id)));
                }
            });
            await Promise.all(promises);
            statusEl.innerText = "Limpeza conclu√≠da!";
            setTimeout(() => initSystem(), 1500);
        };

        window.initSystem = async () => {
            const showTestMode = document.getElementById('toggle-test').checked;
            const statusEl = document.getElementById('system-status');
            const badgeEl = document.getElementById('feed-badge');
            
            if(showTestMode) {
                statusEl.innerText = "MODO TESTE (SandBox)"; statusEl.className = "text-xs text-amber-400 font-bold";
                badgeEl.innerText = "TESTES"; badgeEl.className = "text-[9px] bg-amber-500/20 text-amber-400 px-2 py-1 rounded";
            } else {
                statusEl.innerText = "ONLINE (Real)"; statusEl.className = "text-xs text-emerald-400 font-bold";
                badgeEl.innerText = "DADOS REAIS"; badgeEl.className = "text-[9px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded";
            }

            const eventsRef = collection(db, "analytics_events");
            // Adicionado limite maior e ordena√ß√£o correta
            const snapshot = await getDocs(query(eventsRef, orderBy("timestamp", "desc"), limit(500)));
            
            const sessions = {};
            
            snapshot.forEach(doc => {
                const data = doc.data();
                // Filtro visual
                if (showTestMode && data.isTest !== true) return;
                if (!showTestMode && data.isTest === true) return;

                const sid = data.sessionId || 'anon';
                if (!sessions[sid]) sessions[sid] = { id: sid, events: [], source: data.campaign?.source || 'direct', maxStep: 0, reachedCheckout: false };
                sessions[sid].events.push(data);
                
                if (data.eventName === 'quiz_answer' && (data.data.question_number || 0) > sessions[sid].maxStep) sessions[sid].maxStep = data.data.question_number || 0;
                if (data.eventName === 'click' && (data.data.label?.includes('Desbloquear') || data.data.id === 'btn-checkout')) sessions[sid].reachedCheckout = true;
            });

            const funnel = { visitors: 0, startedQuiz: 0, midQuiz: 0, finishedQuiz: 0, clickedCheckout: 0 };
            const sourcesCount = {};

            Object.values(sessions).forEach(s => {
                funnel.visitors++;
                sourcesCount[s.source] = (sourcesCount[s.source] || 0) + 1;
                const hasQuiz = s.events.some(e => e.eventName === 'quiz_answer');
                if (hasQuiz || s.maxStep > 0) funnel.startedQuiz++;
                if (s.maxStep >= 5) funnel.midQuiz++;
                if (s.maxStep >= 9) funnel.finishedQuiz++;
                if (s.reachedCheckout) funnel.clickedCheckout++;
            });

            window.globalFunnelData = funnel; 
            window.globalSourceData = sourcesCount;
            renderDashboard(funnel, Object.keys(sessions).length, sessions, sourcesCount);
        };

        function renderDashboard(funnel, total, sessions, sources) {
            const container = document.getElementById('funnel-container');
            const steps = [
                { label: "Visitas", count: funnel.visitors, color: "text-white" },
                { label: "Iniciou Quiz", count: funnel.startedQuiz, color: "text-indigo-400" },
                { label: "Engajados", count: funnel.midQuiz, color: "text-purple-400" },
                { label: "Finalizou", count: funnel.finishedQuiz, color: "text-fuchsia-400" },
                { label: "Checkout", count: funnel.clickedCheckout, color: "text-emerald-400" }
            ];
            
            let html = '';
            steps.forEach((step, index) => {
                const prev = index === 0 ? step.count : steps[index-1].count;
                const conv = prev > 0 ? ((step.count / prev) * 100).toFixed(1) : 0;
                const tot = total > 0 ? ((step.count / total) * 100).toFixed(1) : 0;
                html += `<div class="funnel-step active"><div class="flex justify-between items-end"><div><p class="text-[10px] uppercase text-slate-500 font-bold">${step.label}</p><p class="text-xl font-black ${step.color}">${step.count}</p></div><div class="text-right"><p class="text-xs font-bold text-slate-400">${conv}% <span class="text-[9px] opacity-50">ant.</span></p></div></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${tot}%"></div></div></div>`;
            });
            container.innerHTML = html;
            
            document.getElementById('kpi-unique').innerText = total;
            document.getElementById('kpi-cr').innerText = (funnel.finishedQuiz > 0 ? ((funnel.clickedCheckout/funnel.finishedQuiz)*100).toFixed(1) : 0) + "%";
            document.getElementById('kpi-retention').innerText = (funnel.visitors > 0 ? ((funnel.finishedQuiz/funnel.visitors)*100).toFixed(1) : 0) + "%";
            
            const bestSrc = Object.keys(sources).length > 0 ? Object.keys(sources).reduce((a, b) => sources[a] > sources[b] ? a : b) : '-';
            document.getElementById('kpi-source').innerText = bestSrc.toUpperCase();

            const feed = document.getElementById('live-feed');
            feed.innerHTML = '';
            // Ordena√ß√£o segura
            Object.values(sessions)
                .sort((a,b) => {
                    const tA = a.events[0]?.timestamp?.seconds || 0;
                    const tB = b.events[0]?.timestamp?.seconds || 0;
                    return tB - tA;
                })
                .slice(0, 20)
                .forEach(s => {
                    const time = s.events[0]?.timestamp ? new Date(s.events[0].timestamp.seconds*1000).toLocaleTimeString() : '--:--';
                    feed.innerHTML += `<div class="p-3 bg-white/5 rounded border border-white/5 mb-2"><div class="flex justify-between"><span class="text-xs text-slate-400">${time}</span><span class="text-[9px] bg-slate-700 px-2 rounded text-white">${s.source}</span></div><div class="text-xs text-slate-300 mt-1">${s.events.length} a√ß√µes</div></div>`;
                });
            
            const ctx = document.getElementById('sourceChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(sources), datasets: [{ data: Object.values(sources), backgroundColor: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b'], borderWidth:0 }] }, options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } } } } });
        }
        
        // Inicia o sistema
        initSystem();
    </script>
